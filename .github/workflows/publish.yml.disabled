name: ğŸ“¦ Publish CLI to npm

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ›’ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10.11.1"
          run_install: false

      - name: ğŸ—ƒï¸ Setup npm registry
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      - name: ğŸ“š Install dependencies
        run: |
          pnpm install
          cd packages/create-fastify-project && pnpm install

      - name: ğŸ” Validate version sync
        run: |
          # Extract version from git tag (v1.2.3 -> 1.2.3)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          CLI_VERSION=$(cd packages/create-fastify-project && node -p "require('./package.json').version")

          if [ "$TAG_VERSION" != "$CLI_VERSION" ]; then
            echo "âŒ Version mismatch: Git tag is v$TAG_VERSION but CLI package.json is $CLI_VERSION"
            exit 1
          fi

          echo "âœ… Version sync confirmed: $TAG_VERSION"

      - name: ğŸ—ï¸ Build CLI
        run: |
          cd packages/create-fastify-project
          echo "ğŸ”¨ Building CLI..."
          pnpm build

          echo "ğŸ“ Build output verification:"
          ls -la dist/ || echo "âŒ No dist directory created"
          echo "ğŸ“„ Files in dist:"
          find dist/ -type f -name "*.js" 2>/dev/null || echo "âŒ No JS files found in dist"

      - name: ğŸ§ª Test CLI functionality
        run: |
          cd packages/create-fastify-project

          # Debug: Check if dist directory and files exist
          echo "ğŸ“ Checking dist directory contents:"
          ls -la dist/ || echo "âŒ dist directory doesn't exist"

          if [ -f "dist/index.js" ]; then
            echo "âœ… dist/index.js exists"
            echo "ğŸ“„ File permissions:"
            ls -la dist/index.js
            
            # Test version command from the package directory
            echo "ğŸ§ª Testing version command from package directory:"
            VERSION_OUTPUT=$(node dist/index.js --version)
            echo "CLI reports version: $VERSION_OUTPUT"
            
            # Test help command
            echo "ğŸ§ª Testing help command:"
            node dist/index.js --help || echo "âŒ Help command failed"
            
          else
            echo "âŒ dist/index.js is missing"
            exit 1
          fi

          echo "âœ… CLI functionality test passed"

      - name: ğŸ“¦ Publish to npm
        run: |
          cd packages/create-fastify-project
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: âœ… Verify published version
        run: |
          # Wait for npm propagation
          sleep 30

          # Check published version
          PUBLISHED_VERSION=$(npm view create-fastify-project version)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          if [ "$PUBLISHED_VERSION" != "$TAG_VERSION" ]; then
            echo "âš ï¸ Warning: Published version $PUBLISHED_VERSION doesn't match tag $TAG_VERSION"
            echo "This might be due to npm propagation delay"
          else
            echo "âœ… Successfully published version $PUBLISHED_VERSION to npm"
          fi
