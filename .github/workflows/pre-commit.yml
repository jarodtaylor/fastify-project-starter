name: Pre-commit Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  pre-commit:
    name: 🔍 Pre-commit Checks
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: 📥 Install dependencies
        run: pnpm install --frozen-lockfile

      - name: 🔍 Check for common issues
        run: |
          # Check for large files (exclude all node_modules, .git, cli/template, and common large file patterns)
          if find . -type f -size +10M \
            -not -path "*/node_modules/*" \
            -not -path "./.git/*" \
            -not -path "./cli/template/*" \
            -not -path "*/.turbo/*" \
            -not -path "*/dist/*" \
            -not -path "*/build/*" \
            -not -path "*/.next/*" \
            -not -path "*/.react-router/*" \
            -not -name "*.log" | grep -q .; then
            echo "❌ Large files found!"
            find . -type f -size +10M \
              -not -path "*/node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./cli/template/*" \
              -not -path "*/.turbo/*" \
              -not -path "*/dist/*" \
              -not -path "*/build/*" \
              -not -path "*/.next/*" \
              -not -path "*/.react-router/*" \
              -not -name "*.log"
            exit 1
          fi

          # Check for secrets/sensitive data (avoid false positives)
          if grep -r \
            -E '(api_key|apikey|secret_key|private_key|access_token|auth_token|bearer_token)' \
            --include="*.ts" --include="*.js" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=.git \
            --exclude="**/replace-vars.ts" \
            --exclude="**/.env.example" \
            . 2>/dev/null; then
            echo "❌ Potential secrets found!"
            echo "ℹ️  Check for hardcoded API keys, tokens, or passwords"
            exit 1
          fi

          # Check for console.log statements in production files (excluding server startup messages)
          if grep -r "console\.log" apps/ packages/ --include="*.ts" --include="*.tsx" \
            --exclude="**/index.ts" \
            --exclude="**/server.ts" \
            --exclude="**/main.ts" 2>/dev/null; then
            echo "❌ Console.log statements found in production files!"
            echo "ℹ️  Remove debug console.log statements (server startup logs are OK)"
            exit 1
          fi

      - name: 🎨 Check formatting
        run: pnpm format:check

      - name: 🔍 Lint check
        run: pnpm lint

      - name: 🔍 Type check
        run: pnpm typecheck

      - name: 🔍 CLI type check
        run: cd cli && pnpm typecheck
