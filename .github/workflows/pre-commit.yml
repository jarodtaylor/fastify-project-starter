name: Pre-commit Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  pre-commit:
    name: ğŸ” Pre-commit Checks
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup tools with Mise
        uses: jdx/mise-action@v2

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Check for common issues
        run: |
          # Check for large files (exclude all node_modules, .git, templates, and common large file patterns)
          if find . -type f -size +10M \
            -not -path "*/node_modules/*" \
            -not -path "./.git/*" \
            -not -path "./templates/*" \
            -not -path "*/.turbo/*" \
            -not -path "*/dist/*" \
            -not -path "*/build/*" \
            -not -path "*/.next/*" \
            -not -path "*/.react-router/*" \
            -not -name "*.log" | grep -q .; then
            echo "âŒ Large files found!"
            find . -type f -size +10M \
              -not -path "*/node_modules/*" \
              -not -path "./.git/*" \
              -not -path "./templates/*" \
              -not -path "*/.turbo/*" \
              -not -path "*/dist/*" \
              -not -path "*/build/*" \
              -not -path "*/.next/*" \
              -not -path "*/.react-router/*" \
              -not -name "*.log"
            exit 1
          fi

          # Check for secrets/sensitive data (avoid false positives)
          if grep -r \
            -E '(api_key|apikey|secret_key|private_key|access_token|auth_token|bearer_token)' \
            --include="*.ts" --include="*.js" --include="*.json" \
            --exclude-dir=node_modules --exclude-dir=.git \
            --exclude="**/replace-vars.ts" \
            --exclude="**/.env.example" \
            . 2>/dev/null; then
            echo "âŒ Potential secrets found!"
            echo "â„¹ï¸  Check for hardcoded API keys, tokens, or passwords"
            exit 1
          fi

          # Check for console.log statements in production files (excluding CLI and server files)
          # CLI tools are expected to have console.log for user output, so we skip CLI checks
          # Only check templates for accidental console.log statements, excluding node_modules and CLI directories
          if grep -r "console\.log" templates/ --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=cli 2>/dev/null | \
             grep -v -E "(.*server\.ts|.*main\.ts|.*index\.ts)"; then
            echo "âŒ Console.log statements found in template files!"
            echo "â„¹ï¸  Remove debug console.log statements (server startup logs are OK)"
            grep -r "console\.log" templates/ --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=cli 2>/dev/null | \
              grep -v -E "(.*server\.ts|.*main\.ts|.*index\.ts)"
            exit 1
          fi

      - name: ğŸ¨ Check formatting (Root)
        run: pnpm format:check

      - name: ğŸ” Lint check (Root)
        run: pnpm lint

      - name: ğŸ” CLI type check
        run: |
          cd packages/create-fastify-project
          pnpm install --frozen-lockfile
          pnpm typecheck

      - name: ğŸ” Template type check
        run: |
          cd templates/react-router
          pnpm install --frozen-lockfile
          pnpm typecheck
